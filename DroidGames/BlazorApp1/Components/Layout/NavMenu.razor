@implements IDisposable
@inject NavigationManager NavigationManager
@inject BlazorApp1.Services.UserSession UserSession

<nav class="horizontal-nav">
    <ul class="nav-items">
        <!-- Public Links -->
        <li>
            <NavLink href="" Match="NavLinkMatch.All">
                �eb���ek
            </NavLink>
        </li>
        <li>
            <NavLink href="maps">
                Mapy
            </NavLink>
        </li>
        <li>
            <NavLink href="round-order">
                Pořadí kol
            </NavLink>
        </li>

        @if (UserSession.HasRole(BlazorApp1.Models.UserRole.Team))
        {
            <li>
                <NavLink href="team/dashboard">
                    Dashboard
                </NavLink>
            </li>
            <li>
                <NavLink href="team/statistics">
                    Statistiky
                </NavLink>
            </li>
            <li>
                <NavLink href="team/achievements">
                    Achievementy
                </NavLink>
            </li>
        }

        @if (UserSession.HasRole(BlazorApp1.Models.UserRole.Referee) || UserSession.HasRole(BlazorApp1.Models.UserRole.Admin))
        {
            <li>
                <NavLink href="referee/scoring">
                    Bodov�n�
                </NavLink>
            </li>
        }

        @if (UserSession.HasRole(BlazorApp1.Models.UserRole.HeadReferee) || UserSession.HasRole(BlazorApp1.Models.UserRole.Admin))
        {
            <li>
                <NavLink href="headref/control">
                    Ovl�d�n�
                </NavLink>
            </li>
            <li>
                <NavLink href="admin/referee-approval">
                    Schvalov�n�
                </NavLink>
            </li>
        }

        @if (UserSession.HasRole(BlazorApp1.Models.UserRole.Admin))
        {
            <li>
                <NavLink href="admin/teams">
                    Admin
                </NavLink>
            </li>
        }

        <!-- Login / Logout -->
        @if (UserSession.IsAuthenticated)
        {
            <li class="nav-user">
                <span class="material-symbols-outlined user-icon">account_circle</span>
                <div class="user-info">
                    <span class="user-name">@UserSession.Username</span>
                    <span class="user-role">@GetRoleName(UserSession.Role)</span>
                </div>
            </li>
            <li>
                <a href="/logout" class="nav-logout">
                    <span class="material-symbols-outlined">logout</span>
                    <span>Odhl�sit</span>
                </a>
            </li>
        }
        else
        {
            <li>
                <NavLink href="login">
                    <span class="material-symbols-outlined">login</span>
                    <span>P�ihl�sit se</span>
                </NavLink>
            </li>
        }
    </ul>
</nav>

@code {
    protected override void OnInitialized()
    {
        try
        {
            NavigationManager.LocationChanged += OnLocationChanged;
            UserSession.OnChange += StateHasChanged;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR NavMenu.OnInitialized] {ex.Message}");
            Console.WriteLine($"[ERROR StackTrace] {ex.StackTrace}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await UserSession.InitializeAsync();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[ERROR NavMenu.OnAfterRenderAsync] {ex.Message}");
                Console.WriteLine($"[ERROR StackTrace] {ex.StackTrace}");
                // Pokra�ujeme i kdy� inicializace sel�e - u�ivatel nebude p�ihl�en
            }
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    private string GetRoleName(BlazorApp1.Models.UserRole role)
    {
        return role switch
        {
            BlazorApp1.Models.UserRole.Team => "T�m",
            BlazorApp1.Models.UserRole.Referee => "Rozhod��",
            BlazorApp1.Models.UserRole.HeadReferee => "Hlavn� rozhod��",
            BlazorApp1.Models.UserRole.Production => "Produkce",
            BlazorApp1.Models.UserRole.Admin => "Administr�tor",
            _ => "N�v�t�vn�k"
        };
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        UserSession.OnChange -= StateHasChanged;
    }
}

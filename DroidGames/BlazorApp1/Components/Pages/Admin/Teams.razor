@page "/admin/teams"
@inject BlazorApp1.Services.ITeamService TeamService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Správa týmů - Hlavní rozhodčí</PageTitle>

<BlazorApp1.Components.Shared.AuthGuard RequiredRole="BlazorApp1.Models.UserRole.HeadReferee">
    <BlazorApp1.Components.Shared.AdminNav />
    
    <div class="page-shell admin-teams">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <span class="material-symbols-outlined">groups</span>
                    Správa týmů
                </h1>
                <p class="page-subtitle">Jednotný přehled týmů, PIN kódů a rychlých odkazů na detail jízd.</p>
            </div>
        </div>

        @if (_isLoading)
        {
            <div class="state-card">
                <span class="material-symbols-outlined spinning">progress_activity</span>
                <p>Načítání týmů...</p>
            </div>
        }
        else if (_teams != null && _teams.Any())
        {
            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-icon">
                        <span class="material-symbols-outlined">groups</span>
                    </div>
                    <div class="summary-content">
                        <div class="summary-label">Počet týmů</div>
                        <div class="summary-value">@_teamCount</div>
                    </div>
                </div>

                <div class="summary-card">
                    <div class="summary-icon">
                        <span class="material-symbols-outlined">emoji_events</span>
                    </div>
                    <div class="summary-content">
                        <div class="summary-label">Průměrné skóre</div>
                        <div class="summary-value">@_avgScore.ToString("F1")</div>
                    </div>
                </div>

                <div class="summary-card">
                    <div class="summary-icon">
                        <span class="material-symbols-outlined">format_list_numbered</span>
                    </div>
                    <div class="summary-content">
                        <div class="summary-label">Průměr kol</div>
                        <div class="summary-value">@_avgRounds.ToString("F1")</div>
                    </div>
                </div>

                <div class="summary-card">
                    <div class="summary-icon">
                        <span class="material-symbols-outlined">military_tech</span>
                    </div>
                    <div class="summary-content">
                        <div class="summary-label">Lídr</div>
                        <div class="summary-value">@_leaderName</div>
                    </div>
                </div>
            </div>

            <div class="table-card teams-table">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Název týmu</th>
                            <th>Škola</th>
                            <th>PIN</th>
                            <th>Celkové skóre</th>
                            <th>Pozice</th>
                            <th>Kola</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var team in _teams)
                        {
                            <tr>
                                <td class="team-name">@team.Name</td>
                                <td>@team.School</td>
                                <td class="team-pin">@team.PinCode</td>
                                <td class="team-score">@team.TotalScore bodů</td>
                                <td class="team-position">@team.CurrentPosition.</td>
                                <td>@team.Rides.Count</td>
                                <td class="team-actions">
                                    <button class="btn-icon btn-primary" @onclick="() => NavigateToRides(team.Id)" title="Zobrazit jízdy">
                                        <span class="material-symbols-outlined">list</span>
                                    </button>
                                    <button class="btn-icon btn-info" @onclick="() => NavigateToEdit(team.Id)" title="Upravit">
                                        <span class="material-symbols-outlined">edit</span>
                                    </button>
                                    <button class="btn-icon btn-danger" @onclick="() => DeleteTeam(team.Id)" title="Smazat">
                                        <span class="material-symbols-outlined">delete</span>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="state-card">
                <span class="material-symbols-outlined">groups</span>
                <p>Žádné týmy ještě nebyly přidány</p>
            </div>
        }
    </div>
</BlazorApp1.Components.Shared.AuthGuard>

@code {
    private List<BlazorApp1.Models.Team>? _teams;
    private bool _isLoading = true;
    private int _teamCount;
    private double _avgScore;
    private double _avgRounds;
    private string _leaderName = "-";

    protected override async Task OnInitializedAsync()
    {
        await LoadTeams();
    }

    private async Task LoadTeams()
    {
        _isLoading = true;
        _teams = await TeamService.GetLeaderboardAsync();
        _isLoading = false;
        
        if (_teams != null && _teams.Any())
        {
            _teamCount = _teams.Count;
            _avgScore = _teams.Average(t => t.TotalScore);
            _avgRounds = _teams.Average(t => t.Rides.Count);
            _leaderName = _teams.OrderByDescending(t => t.TotalScore).FirstOrDefault()?.Name ?? "-";
        }
        StateHasChanged();
    }

    private void NavigateToRides(string teamId)
    {
        Navigation.NavigateTo($"/admin/teams/{teamId}/rides");
    }

    private void NavigateToEdit(string teamId)
    {
        Navigation.NavigateTo($"/admin/teams/{teamId}/edit");
    }

    private void DeleteTeam(string teamId)
    {
        // TODO: Implementovat potvrzovací dialog
        // Zatím neimplementováno pro bezpečnost
    }
}

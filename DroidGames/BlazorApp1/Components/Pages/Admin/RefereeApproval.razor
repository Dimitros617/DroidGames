@page "/admin/referee-approval"
@using BlazorApp1.Models
@using BlazorApp1.Services
@inject ITeamService TeamService
@inject IMapService MapService
@inject IScoreService ScoreService
@inject IAuthService AuthService
@inject IFinalScoreService FinalScoreService
@inject IScoreNotificationService ScoreNotificationService
@inject IAchievementEvaluationService AchievementEvaluationService
@inject IGameStatusService GameStatusService
@inject CompetitionSettings Settings
@inject NavigationManager Navigation
@inject UserSession UserSession
@inject ITimerService TimerService
@implements IDisposable

<PageTitle>Schvalov√°n√≠ hodnocen√≠ - Hlavn√≠ rozhodƒç√≠</PageTitle>

<BlazorApp1.Components.Shared.AuthGuard RequiredRoles="@(new[] { UserRole.HeadReferee })">
    <div class="admin-approval-page">
        <div class="page-header">
            <h1>üéØ Schvalov√°n√≠ hodnocen√≠ rozhodƒç√≠ch</h1>
            <p>Kontrola a schvalov√°n√≠ bodov√°n√≠ od rozhodƒç√≠ch</p>
        </div>

        @if (!_isInitialized)
        {
            <div class="loading">
                <div class="spinner"></div>
                <p>Naƒç√≠t√°n√≠...</p>
            </div>
        }
        else
        {
            <!-- Ovl√°d√°n√≠ soutƒõ≈æe -->
            <div class="competition-controls">
                <h2>‚è±Ô∏è ≈ò√≠zen√≠ kola @_currentRoundNumber</h2>
                <div class="timer-controls">
                    <button class="btn btn-success" @onclick="StartTimer" disabled="@(Settings.TimerStatus == TimerStatus.Running)">
                        ‚ñ∂Ô∏è Start
                    </button>
                    <button class="btn btn-warning" @onclick="StopTimer" disabled="@(Settings.TimerStatus != TimerStatus.Running)">
                        ‚è∏Ô∏è Stop
                    </button>
                    <button class="btn btn-danger" @onclick="ResetTimer">
                        üîÑ Reset
                    </button>
                    <div class="timer-display">
                        <span class="timer-time">@FormatTime(_remainingSeconds)</span>
                    </div>
                </div>
            </div>

            <!-- Mapa -->
            @if (_selectedMap != null)
            {
                <div class="map-preview">
                    <h3>üó∫Ô∏è Mapa: @_selectedMap.Name</h3>
                    <div class="map-grid-small">
                        @for (int y = 0; y < 6; y++)
                        {
                            @for (int x = 0; x < 9; x++)
                            {
                                var block = GetBlockAt(x, y);
                                var cssClass = $"map-cell-small {GetBlockClass(block)}";
                                
                                <div class="@cssClass">
                                    @if (block != null && block.Type != MapBlockType.Empty)
                                    {
                                        <span class="block-icon-small">@GetBlockIcon(block.Type)</span>
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>
            }

            <!-- Tabulka hodnocen√≠ -->
            <div class="scoring-table-section">
                <h2>üìä Hodnocen√≠ t√Ωm≈Ø</h2>
                
                @if (_currentTeamPair != null && _currentTeamPair.Count >= 2)
                {
                    <div class="team-pair-info">
                        <strong>Aktu√°ln√≠ dvojice:</strong> @_currentTeamPair[0].Name vs @_currentTeamPair[1].Name
                    </div>

                    @foreach (var team in _currentTeamPair)
                    {
                        <div class="team-scoring-block">
                            <h3>üéØ @team.Name</h3>
                            
                            <table class="scoring-table">
                                <thead>
                                    <tr>
                                        <th>Rozhodƒç√≠</th>
                                        <th>üíé Krystaly</th>
                                        <th>üü° S√≠ra</th>
                                        <th>üéÅ Bonusy</th>
                                        <th>üìä Celkem</th>
                                        <th>Status</th>
                                        <th>Akce</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var referee in _allReferees)
                                    {
                                        var scoreData = GetRefereeScoreForTeam(team.Id, referee.Id);
                                        var hasScore = scoreData.HasScore;
                                        var score = scoreData.Score;
                                        var breakdown = scoreData.Breakdown;
                                        var isExpanded = IsRowExpanded(team.Id, referee.Id);
                                        
                                        <tr class="@GetRowClass(score) @(isExpanded ? "expanded" : "")" @onclick="() => ToggleRowExpansion(team.Id, referee.Id)">
                                            <td>
                                                <span class="expand-icon">@(isExpanded ? "‚ñº" : "‚ñ∂")</span>
                                                <strong>@referee.Username</strong>
                                            </td>
                                            <td class="score-cell">@(hasScore ? breakdown.CrystalPoints : "-")</td>
                                            <td class="score-cell">@(hasScore ? breakdown.SulfurPenalty : "-")</td>
                                            <td class="score-cell">@(hasScore ? breakdown.BonusPoints : "-")</td>
                                            <td class="score-cell total"><strong>@(hasScore ? score!.TotalScore : "-")</strong></td>
                                            <td class="status-cell">
                                                @if (!hasScore)
                                                {
                                                    <span class="badge badge-not-started">Nezad√°no</span>
                                                }
                                                else if (score!.IsApproved)
                                                {
                                                    <span class="badge badge-approved">‚úÖ Schv√°leno</span>
                                                }
                                                else if (score.IsRejected)
                                                {
                                                    <span class="badge badge-rejected">‚Ü©Ô∏è Vr√°ceno</span>
                                                }
                                                else if (score.IsSubmitted)
                                                {
                                                    <span class="badge badge-submitted">‚è≥ ƒåek√°</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-editing">‚úèÔ∏è Hodnot√≠</span>
                                                }
                                            </td>
                                            <td class="action-cell" @onclick:stopPropagation="true">
                                                @if (hasScore && score!.IsSubmitted && !score.IsApproved && !score.IsRejected)
                                                {
                                                    <button class="btn btn-sm btn-reject" @onclick="() => ShowRejectDialog(team.Id, referee.Id)">
                                                        ‚Ü©Ô∏è Vr√°tit
                                                    </button>
                                                }
                                                else if (hasScore && score!.IsRejected)
                                                {
                                                    <span class="text-muted">ƒåek√° na opravu</span>
                                                }
                                                else if (hasScore && score!.IsApproved)
                                                {
                                                    <span class="text-success">‚úì Hotovo</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                        
                                        @if (isExpanded && hasScore && score!.Events.Any())
                                        {
                                            <tr class="detail-row">
                                                <td colspan="7">
                                                    <div class="events-detail">
                                                        <h4>üìã Detail ud√°lost√≠ rozhodƒç√≠ho @referee.Username</h4>
                                                        <table class="events-table-readonly">
                                                            <thead>
                                                                <tr>
                                                                    <th>#</th>
                                                                    <th>Pozice</th>
                                                                    <th>Typ bloku</th>
                                                                    <th>Popis</th>
                                                                    <th>Body</th>
                                                                    <th>ƒåas</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var evt in score.Events.OrderBy(e => e.Timestamp))
                                                                {
                                                                    <tr class="@GetEventRowClass(evt)">
                                                                        <td>@evt.Id</td>
                                                                        <td>[@evt.X, @evt.Y]</td>
                                                                        <td>@GetBlockIconByName(evt.BlockType)</td>
                                                                        <td>@evt.Description</td>
                                                                        <td class="@(evt.Points >= 0 ? "points-positive" : "points-negative")">
                                                                            @(evt.Points >= 0 ? "+" : "")@evt.Points
                                                                        </td>
                                                                        <td>@evt.Timestamp.ToString("HH:mm:ss")</td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                        <div class="events-summary">
                                                            <strong>Celkov√Ω poƒçet ud√°lost√≠:</strong> @score.Events.Count
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                            
                            <!-- V√Ωsledek porovn√°n√≠ -->
                            @{
                                var comparison = CompareTeamScores(team.Id);
                            }
                            @if (comparison.AllSubmitted)
                            {
                                <div class="comparison-result @(comparison.AllMatch ? "match" : "mismatch")">
                                    @if (comparison.AllMatch)
                                    {
                                        <div class="match-message">
                                            ‚úÖ <strong>V≈°echna hodnocen√≠ se shoduj√≠!</strong>
                                            <div class="match-details">
                                                <span>üíé Krystaly: @comparison.CrystalPoints</span>
                                                <span>üü° S√≠ra: @comparison.SulfurPenalty</span>
                                                <span>üéÅ Bonusy: @comparison.BonusPoints</span>
                                                <span class="total">üìä Celkem: @comparison.TotalScore</span>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="mismatch-message">
                                            ‚ö†Ô∏è <strong>Hodnocen√≠ se neshoduj√≠!</strong>
                                            <p>Zkontrolujte jednotliv√° hodnocen√≠ a vra≈•te nespr√°vn√° k opravƒõ.</p>
                                            @if (comparison.Differences.Any())
                                            {
                                                <ul class="differences-list">
                                                    @foreach (var diff in comparison.Differences)
                                                    {
                                                        <li>@diff</li>
                                                    }
                                                </ul>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    
                    <!-- Glob√°ln√≠ schv√°len√≠ pro celou dvojici -->
                    <div class="global-approval-section">
                        @{
                            var canApprove = CanApproveRound();
                        }
                        @if (canApprove)
                        {
                            <button class="btn btn-lg btn-approve-all" @onclick="ApproveRound">
                                ‚úÖ Schv√°lit kolo pro oba t√Ωmy
                            </button>
                            <p class="help-text">‚úì V≈°echna hodnocen√≠ jsou odeslan√° a shoduj√≠ se v bodech</p>
                        }
                        else
                        {
                            <button class="btn btn-lg btn-approve-all" disabled>
                                ‚úÖ Schv√°lit kolo pro oba t√Ωmy
                            </button>
                            <p class="help-text error">‚ö†Ô∏è Nelze schv√°lit - hodnocen√≠ se neshoduj√≠ nebo nejsou v≈°echna odeslan√°</p>
                        }
                    </div>
                    
                    <div class="next-pair-section">
                        <button class="btn btn-lg btn-next" 
                                @onclick="NextTeamPair"
                                disabled="@(!AllScoresApproved())">
                            ‚û°Ô∏è Dal≈°√≠ dvojice
                        </button>
                        @if (!AllScoresApproved())
                        {
                            <p class="help-text">‚ö†Ô∏è Mus√≠te schv√°lit kolo p≈ôed p≈ôechodem na dal≈°√≠ dvojici</p>
                        }
                    </div>
                }
                else
                {
                    <div class="no-teams">
                        <p>≈Ω√°dn√© t√Ωmy k hodnocen√≠</p>
                    </div>
                }
            </div>
        }

        @if (!string.IsNullOrEmpty(_statusMessage))
        {
            <div class="toast @(_isError ? "error" : "success")">
                @_statusMessage
            </div>
        }
        
        @if (_showRejectDialog)
        {
            <div class="dialog-overlay" @onclick="CancelReject">
                <div class="dialog-box" @onclick:stopPropagation="true">
                    <h3>‚Ü©Ô∏è Vr√°tit hodnocen√≠</h3>
                    <p>D≈Øvod vr√°cen√≠ (voliteln√©):</p>
                    <textarea class="form-control" @bind="_rejectionReason" rows="3" placeholder="Nap≈ô: Chybn√© bodov√°n√≠ krystal≈Ø..."></textarea>
                    <div class="dialog-actions">
                        <button class="btn btn-secondary" @onclick="CancelReject">Zru≈°it</button>
                        <button class="btn btn-danger" @onclick="ExecuteReject">Vr√°tit k opravƒõ</button>
                    </div>
                </div>
            </div>
        }
    </div>
</BlazorApp1.Components.Shared.AuthGuard>

@code {
    private bool _isInitialized = false;
    private MapConfiguration? _selectedMap = null;
    private List<Team> _allTeams = new();
    private List<Team> _currentTeamPair = new();
    private List<User> _allReferees = new();
    private int _currentRoundNumber = 1;
    private int _currentPairIndex = 0;
    private int _remainingSeconds = 300;
    private System.Threading.Timer? _timer;
    
    private string _statusMessage = string.Empty;
    private bool _isError = false;
    
    private bool _showRejectDialog = false;
    private string _rejectionReason = string.Empty;
    private string _rejectTeamId = string.Empty;
    private string _rejectRefereeId = string.Empty;
    
    private HashSet<string> _expandedRows = new();

    // Helper class pro porovn√°n√≠ hodnocen√≠
    public class ScoreComparison
    {
        public bool AllSubmitted { get; set; }
        public bool AllMatch { get; set; }
        public int CrystalPoints { get; set; }
        public int SulfurPenalty { get; set; }
        public int BonusPoints { get; set; }
        public int TotalScore { get; set; }
        public List<string> Differences { get; set; } = new();
    }
    
    // Helper class pro rozlo≈æen√≠ bod≈Ø
    public class ScoreBreakdownData
    {
        public int CrystalPoints { get; set; }
        public int SulfurPenalty { get; set; }
        public int BonusPoints { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        
        // Subscribe to real-time notifications
        ScoreNotificationService.OnRefereeScoreUpdated += HandleRefereeScoreUpdated;
        ScoreNotificationService.OnScoreApprovalChanged += HandleScoreApprovalChanged;
        
        _isInitialized = true;
        StartTimerUpdate();
    }
    
    private async Task HandleRefereeScoreUpdated(string teamId, int roundNumber, string refereeId)
    {
        Console.WriteLine($"[HeadRef] Referee {refereeId} score updated for team {teamId}, round {roundNumber}");
        
        await InvokeAsync(async () =>
        {
            await ReloadTeamData(teamId);
            StateHasChanged();
        });
    }
    
    private async Task HandleScoreApprovalChanged(string teamId, string refereeId)
    {
        Console.WriteLine($"[HeadRef] Score approval changed for team {teamId}, referee {refereeId}");
        
        await InvokeAsync(async () =>
        {
            await ReloadTeamData(teamId);
            StateHasChanged();
        });
    }

    private async Task ReloadTeamData(string teamId)
    {
        var updatedTeam = await TeamService.GetTeamByIdAsync(teamId);
        if (updatedTeam != null)
        {
            var index = _allTeams.FindIndex(t => t.Id == teamId);
            if (index >= 0)
            {
                _allTeams[index] = updatedTeam;
            }
            
            // Update current team pair if needed
            for (int i = 0; i < _currentTeamPair.Count; i++)
            {
                if (_currentTeamPair[i].Id == teamId)
                {
                    _currentTeamPair[i] = updatedTeam;
                    break;
                }
            }
        }
    }

    private async Task LoadData()
    {
        _allTeams = await TeamService.GetAllTeamsAsync();
        
        var maps = await MapService.GetAllMapsAsync();
        _selectedMap = maps.FirstOrDefault(m => m.IsPublished);
        
        // Load all users with Referee role
        var allUsers = await AuthService.GetAllUsersAsync();
        _allReferees = allUsers.Where(u => u.Role == UserRole.Referee).ToList();
        
        Console.WriteLine($"[LoadData] Loaded {_allReferees.Count} referees");
        
        LoadCurrentTeamPair();
    }

    private void LoadCurrentTeamPair()
    {
        _currentTeamPair.Clear();
        
        int startIndex = _currentPairIndex * 2;
        if (startIndex < _allTeams.Count)
        {
            _currentTeamPair.Add(_allTeams[startIndex]);
            if (startIndex + 1 < _allTeams.Count)
            {
                _currentTeamPair.Add(_allTeams[startIndex + 1]);
            }
        }
    }

    private (bool HasScore, RefereeScore? Score, ScoreBreakdownData Breakdown) GetRefereeScoreForTeam(string teamId, string refereeId)
    {
        var team = _allTeams.FirstOrDefault(t => t.Id == teamId);
        if (team == null) return (false, null, new ScoreBreakdownData());
        
        var round = team.Rides.FirstOrDefault(r => r.RoundNumber == _currentRoundNumber);
        if (round == null) return (false, null, new ScoreBreakdownData());
        
        if (round.RefereeScores.TryGetValue(refereeId, out var score))
        {
            var breakdown = ParseScoreBreakdown(score);
            return (true, score, breakdown);
        }
        
        return (false, null, new ScoreBreakdownData());
    }
    
    /// <summary>
    /// Rozlo≈æ√≠ ScoreBreakdown na strukturovan√© hodnoty pro krystaly, s√≠ru a bonusy
    /// </summary>
    private ScoreBreakdownData ParseScoreBreakdown(RefereeScore score)
    {
        var result = new ScoreBreakdownData();
        
        foreach (var entry in score.ScoreBreakdown)
        {
            var key = entry.Key.ToLower();
            var value = entry.Value;
            
            if (key.Contains("krystal") || key.Contains("crystal"))
            {
                result.CrystalPoints += value;
            }
            else if (key.Contains("s√≠r") || key.Contains("sulfur"))
            {
                result.SulfurPenalty += value;
            }
            else
            {
                // V≈°e ostatn√≠ jsou bonusy (validn√≠ p≈ôesuny, prvn√≠ dotyk, shroma≈ædi≈°tƒõ...)
                result.BonusPoints += value;
            }
        }
        
        return result;
    }

    /// <summary>
    /// Porovn√° hodnocen√≠ v≈°ech rozhodƒç√≠ch pro dan√Ω t√Ωm
    /// </summary>
    private ScoreComparison CompareTeamScores(string teamId)
    {
        var comparison = new ScoreComparison();
        var team = _allTeams.FirstOrDefault(t => t.Id == teamId);
        if (team == null) return comparison;
        
        var round = team.Rides.FirstOrDefault(r => r.RoundNumber == _currentRoundNumber);
        if (round == null) return comparison;
        
        // Z√≠skat v≈°echna odeslan√° hodnocen√≠
        var submittedScores = new List<(RefereeScore Score, ScoreBreakdownData Breakdown)>();
        
        foreach (var referee in _allReferees)
        {
            if (round.RefereeScores.TryGetValue(referee.Id, out var score))
            {
                if (!score.IsSubmitted || score.IsRejected)
                    continue; // Skip neodeslan√° nebo vr√°cen√° hodnocen√≠
                    
                var breakdown = ParseScoreBreakdown(score);
                submittedScores.Add((score, breakdown));
            }
        }
        
        // Zkontrolovat, zda jsou v≈°echna hodnocen√≠ odeslan√°
        comparison.AllSubmitted = submittedScores.Count == _allReferees.Count;
        
        if (submittedScores.Count == 0)
        {
            return comparison;
        }
        
        // Prvn√≠ hodnocen√≠ jako referenƒçn√≠
        var reference = submittedScores[0];
        comparison.CrystalPoints = reference.Breakdown.CrystalPoints;
        comparison.SulfurPenalty = reference.Breakdown.SulfurPenalty;
        comparison.BonusPoints = reference.Breakdown.BonusPoints;
        comparison.TotalScore = reference.Score.TotalScore;
        
        // Porovnat s ostatn√≠mi
        comparison.AllMatch = true;
        
        for (int i = 1; i < submittedScores.Count; i++)
        {
            var current = submittedScores[i];
            
            if (current.Breakdown.CrystalPoints != comparison.CrystalPoints)
            {
                comparison.AllMatch = false;
                comparison.Differences.Add($"Krystaly: {comparison.CrystalPoints} vs {current.Breakdown.CrystalPoints}");
            }
            
            if (current.Breakdown.SulfurPenalty != comparison.SulfurPenalty)
            {
                comparison.AllMatch = false;
                comparison.Differences.Add($"S√≠ra: {comparison.SulfurPenalty} vs {current.Breakdown.SulfurPenalty}");
            }
            
            if (current.Breakdown.BonusPoints != comparison.BonusPoints)
            {
                comparison.AllMatch = false;
                comparison.Differences.Add($"Bonusy: {comparison.BonusPoints} vs {current.Breakdown.BonusPoints}");
            }
            
            if (current.Score.TotalScore != comparison.TotalScore)
            {
                comparison.AllMatch = false;
                comparison.Differences.Add($"Celkem: {comparison.TotalScore} vs {current.Score.TotalScore}");
            }
        }
        
        return comparison;
    }

    private bool CanApproveRound()
    {
        // Zkontrolovat oba t√Ωmy v aktu√°ln√≠ dvojici
        foreach (var team in _currentTeamPair)
        {
            var comparison = CompareTeamScores(team.Id);
            
            if (!comparison.AllSubmitted || !comparison.AllMatch)
            {
                return false;
            }
        }
        
        return true;
    }

    private async Task ApproveRound()
    {
        if (!CanApproveRound())
        {
            ShowMessage("‚ùå Nelze schv√°lit - hodnocen√≠ se neshoduj√≠ nebo nejsou v≈°echna odeslan√°", true);
            return;
        }
        
        try
        {
            Console.WriteLine($"[ApproveRound] Starting approval for round {_currentRoundNumber}");
            
            foreach (var team in _currentTeamPair)
            {
                await ApproveTeamRound(team.Id);
            }
            
            // Zmƒõnit stav hry na "P≈ô√≠prava dal≈°√≠ j√≠zdy"
            await GameStatusService.SetGameStatusAsync(GameStatus.PreparingNextRound);
            
            ShowMessage($"‚úÖ Kolo {_currentRoundNumber} schv√°leno pro oba t√Ωmy!", false);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ApproveRound] Error: {ex.Message}");
            ShowMessage($"‚ùå Chyba p≈ôi schvalov√°n√≠: {ex.Message}", true);
        }
    }

    private async Task ApproveTeamRound(string teamId)
    {
        var team = await TeamService.GetTeamByIdAsync(teamId);
        if (team == null) return;
        
        var round = team.Rides.FirstOrDefault(r => r.RoundNumber == _currentRoundNumber);
        if (round == null) return;
        
        // Oznaƒçit v≈°echna hodnocen√≠ jako schv√°len√°
        var adminId = UserSession.UserId ?? "admin";
        
        foreach (var referee in _allReferees)
        {
            if (round.RefereeScores.TryGetValue(referee.Id, out var score))
            {
                score.IsApproved = true;
                score.ApprovedAt = DateTime.UtcNow;
                score.ApprovedByRefereeId = adminId;
            }
        }
        
        // Oznaƒçit cel√© kolo jako schv√°len√©
        round.IsApproved = true;
        
        await TeamService.UpdateTeamAsync(team);
        
        // Vz√≠t prvn√≠ hodnocen√≠ jako referenƒçn√≠ (v≈°echna jsou shodn√°)
        var firstScore = round.RefereeScores.Values.First();
        var breakdown = ParseScoreBreakdown(firstScore);
        
        // Vytvo≈ôit fin√°ln√≠ z√°znam
        var finalScore = new FinalRoundScore
        {
            TeamId = teamId,
            RoundNumber = _currentRoundNumber,
            CrystalTouches = firstScore.Events.Count(e => e.Description.Contains("Dotyk krystalu")),
            CrystalPoints = breakdown.CrystalPoints,
            SulfurHits = firstScore.Events.Count(e => e.Description.Contains("Naru≈°en√≠ s√≠ry")),
            SulfurPenalty = breakdown.SulfurPenalty,
            ValidMoves = firstScore.Events.Count(e => e.Description.Contains("Validn√≠ p≈ôesun")),
            BonusPoints = breakdown.BonusPoints,
            TotalScore = firstScore.TotalScore,
            ApprovedAt = DateTime.UtcNow,
            ApprovedBy = adminId,
            MapConfigurationId = round.MapConfigurationId,
            Events = firstScore.Events
        };
        
        // Rozlo≈æit bonusy do detailu
        foreach (var entry in firstScore.ScoreBreakdown)
        {
            var key = entry.Key.ToLower();
            if (!key.Contains("krystal") && !key.Contains("s√≠r") && !key.Contains("crystal") && !key.Contains("sulfur"))
            {
                finalScore.BonusBreakdown[entry.Key] = entry.Value;
            }
        }
        
        await FinalScoreService.SaveFinalScoreAsync(finalScore);
        
        Console.WriteLine($"[ApproveTeamRound] Final score saved for team {teamId}, round {_currentRoundNumber}: {finalScore.TotalScore} points");
        
        // Odeslat notifikaci o dokonƒçen√≠ j√≠zdy
        var roundCompletedNotification = new RoundCompletedNotification
        {
            TeamId = teamId,
            RoundNumber = _currentRoundNumber,
            CrystalPoints = breakdown.CrystalPoints,
            SulfurPenalty = breakdown.SulfurPenalty,
            BonusPoints = breakdown.BonusPoints,
            TotalScore = firstScore.TotalScore,
            CompletedAt = DateTime.UtcNow
        };
        
        await ScoreNotificationService.NotifyRoundCompleted(teamId, roundCompletedNotification);
        
        // Vyhodnotit achievementy
        var unlockedAchievements = await AchievementEvaluationService.EvaluateRoundAchievementsAsync(teamId, _currentRoundNumber);
        
        // Odeslat notifikace o achievementech (postupnƒõ s mal√Ωm zpo≈ædƒõn√≠m pro efekt)
        if (unlockedAchievements != null && unlockedAchievements.Any())
        {
            foreach (var achievement in unlockedAchievements)
            {
                var achievementNotification = new AchievementUnlockedNotification
                {
                    TeamId = teamId,
                    AchievementId = achievement.Id,
                    AchievementName = achievement.Name,
                    AchievementDescription = achievement.Description,
                    Icon = achievement.Icon,
                    Rarity = achievement.Rarity,
                    Points = 0, // Achievementy ned√°vaj√≠ p≈ô√≠m√© body
                    UnlockedAt = DateTime.UtcNow
                };
                
                await ScoreNotificationService.NotifyAchievementUnlocked(teamId, achievementNotification);
                
                // Mal√© zpo≈ædƒõn√≠ mezi achievementy pro lep≈°√≠ vizu√°ln√≠ efekt
                await Task.Delay(500);
            }
        }
    }

    private string GetRowClass(RefereeScore? score)
    {
        if (score == null) return "row-not-started";
        if (score.IsApproved) return "row-approved";
        if (score.IsRejected) return "row-rejected";
        if (score.IsSubmitted) return "row-submitted";
        return "row-editing";
    }

    private bool AllScoresApproved()
    {
        foreach (var team in _currentTeamPair)
        {
            var round = team.Rides.FirstOrDefault(r => r.RoundNumber == _currentRoundNumber);
            if (round == null || !round.IsApproved)
            {
                return false;
            }
        }
        return true;
    }

    private void ShowRejectDialog(string teamId, string refereeId)
    {
        _rejectTeamId = teamId;
        _rejectRefereeId = refereeId;
        _rejectionReason = string.Empty;
        _showRejectDialog = true;
    }

    private void CancelReject()
    {
        _showRejectDialog = false;
        _rejectTeamId = string.Empty;
        _rejectRefereeId = string.Empty;
        _rejectionReason = string.Empty;
    }

    private async Task ExecuteReject()
    {
        try
        {
            var team = _allTeams.FirstOrDefault(t => t.Id == _rejectTeamId);
            if (team == null) return;
            
            var round = team.Rides.FirstOrDefault(r => r.RoundNumber == _currentRoundNumber);
            if (round == null) return;
            
            if (round.RefereeScores.TryGetValue(_rejectRefereeId, out var score))
            {
                score.IsSubmitted = false;
                score.IsApproved = false;
                score.IsRejected = true;
                score.RejectionReason = _rejectionReason;
                
                await TeamService.UpdateTeamAsync(team);
                
                // Send real-time notification
                await ScoreNotificationService.NotifyScoreApprovalChanged(_rejectTeamId, _rejectRefereeId);
                
                ShowMessage("‚Ü©Ô∏è Hodnocen√≠ vr√°ceno k opravƒõ!", false);
                _showRejectDialog = false;
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"‚ùå Chyba: {ex.Message}", true);
        }
    }

    private async Task NextTeamPair()
    {
        if (!AllScoresApproved()) return;
        
        _currentPairIndex++;
        LoadCurrentTeamPair();
        
        if (_currentTeamPair.Count == 0)
        {
            ShowMessage("üéâ V≈°echny dvojice dokonƒçeny!", false);
            _currentPairIndex = 0;
            LoadCurrentTeamPair();
        }
        
        await Task.CompletedTask;
    }

    private MapBlock? GetBlockAt(int x, int y)
    {
        return _selectedMap?.Blocks.FirstOrDefault(b => b.X == x && b.Y == y);
    }

    private string GetBlockClass(MapBlock? block)
    {
        if (block == null) return "empty";
        return block.Type switch
        {
            MapBlockType.Rock => "rock",
            MapBlockType.BlueCrystal => "blue-crystal",
            MapBlockType.YellowSulfur => "yellow-sulfur",
            _ => "empty"
        };
    }

    private string GetBlockIcon(MapBlockType type)
    {
        return type switch
        {
            MapBlockType.Rock => "ü™®",
            MapBlockType.BlueCrystal => "üíé",
            MapBlockType.YellowSulfur => "üü°",
            _ => ""
        };
    }

    private async Task StartTimer()
    {
        await TimerService.StartAsync();
        _remainingSeconds = await TimerService.GetRemainingSecondsAsync();
        StartTimerUpdate();
    }

    private async Task StopTimer()
    {
        await TimerService.StopAsync();
        _timer?.Dispose();
        _remainingSeconds = await TimerService.GetRemainingSecondsAsync();
    }

    private async Task ResetTimer()
    {
        await TimerService.ResetAsync();
        _timer?.Dispose();
        _remainingSeconds = await TimerService.GetRemainingSecondsAsync();
    }

    private string FormatTime(int seconds)
    {
        var mins = seconds / 60;
        var secs = seconds % 60;
        return $"{mins:D2}:{secs:D2}";
    }

    private void StartTimerUpdate()
    {
        _timer = new System.Threading.Timer(_ =>
        {
            try
            {
                if (Settings != null)
                {
                    _remainingSeconds = Settings.TimerRemainingSeconds;
                    InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[RefereeApproval] Timer update error: {ex.Message}");
            }
        }, null, 0, 1000);
    }
    
    private bool IsRowExpanded(string teamId, string refereeId)
    {
        return _expandedRows.Contains($"{teamId}_{refereeId}");
    }
    
    private void ToggleRowExpansion(string teamId, string refereeId)
    {
        var key = $"{teamId}_{refereeId}";
        if (_expandedRows.Contains(key))
        {
            _expandedRows.Remove(key);
        }
        else
        {
            _expandedRows.Add(key);
        }
    }
    
    private string GetBlockIconByName(string blockType)
    {
        return blockType switch
        {
            "BlueCrystal" => "üíé",
            "YellowSulfur" => "üü°",
            "Rock" => "ü™®",
            _ => "‚Ä¢"
        };
    }
    
    private string GetEventRowClass(ScoringEventData evt)
    {
        if (evt.Points > 0) return "event-positive";
        if (evt.Points < 0) return "event-negative";
        return "";
    }
    
    private void ShowMessage(string message, bool isError)
    {
        _statusMessage = message;
        _isError = isError;
        StateHasChanged();
        
        Task.Delay(3000).ContinueWith(_ =>
        {
            InvokeAsync(() =>
            {
                _statusMessage = string.Empty;
                StateHasChanged();
            });
        });
    }
    
    public void Dispose()
    {
        _timer?.Dispose();
        
        // Unsubscribe from events
        ScoreNotificationService.OnRefereeScoreUpdated -= HandleRefereeScoreUpdated;
        ScoreNotificationService.OnScoreApprovalChanged -= HandleScoreApprovalChanged;
    }
}

